<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Disponibilidad</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        /* Base style for all calendar date cells */
        .date-cell {
            padding: 0.5rem;
            text-align: center;
            font-size: 0.875rem;
            border-radius: 0.5rem;
            transition: background-color 0.15s, transform 0.1s, box-shadow 0.15s;
        }
        .date-cell:not([disabled]):hover {
            background-color: #eef2ff; /* indigo-50 */
            cursor: pointer; /* Added pointer for clarity */
        }

        /* Style for selected dates */
        .selected-date {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            transform: scale(1.05);
        }

        /* Style for today's date */
        .today {
            box-shadow: 0 0 0 3px #c4b5fd; /* violet-300 ring */
            border-color: transparent !important;
        }

        /* Style for disabled (past) dates */
        .date-cell[disabled] {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none; /* Disable click completely */
        }

        /* Custom style for recurrence checkboxes */
        .day-checkbox-label {
            display: block;
            padding: 0.5rem 0.2rem;
            text-align: center;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background-color 0.15s, border-color 0.15s;
            font-size: 0.875rem;
            font-weight: 500;
        }
        input[type="checkbox"]:checked + .day-checkbox-label {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            border-color: #4f46e5;
        }
        input[type="checkbox"] {
            display: none; /* Hide native checkbox */
        }
        .slot-item {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 1rem;
            align-items: center;
            padding: 0.75rem;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: box-shadow 0.15s;
        }
        .slot-item:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        @media (max-width: 1023px) {
            /* On small screens, stack the items with full width for clarity */
            .slot-item .slot-details {
                grid-column: 1 / -1;
            }
            .slot-item .slot-actions {
                 display: flex;
                 justify-content: flex-end;
                 grid-column: 1 / -1;
                 padding-top: 0.5rem;
                 border-top: 1px solid #f3f4f6;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

<!-- Header -->
<nav class="bg-white shadow-lg border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
            <div class="flex-shrink-0">
                <a href="offering-settings.html" class="flex items-center text-indigo-600 hover:text-indigo-800 font-medium transition-colors text-sm sm:text-base">
                    <svg class="h-4 w-4 sm:h-5 sm:w-5 mr-1 sm:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    <span class="hidden sm:inline">Volver</span>
                    <span class="inline sm:hidden">Volver</span>
                </a>
            </div>
            <div class="flex-shrink-0 w-16">
                <!-- Spacer -->
            </div>
        </div>
    </div>
</nav>

<!-- Message Box for Alerts -->
<div id="messageBox" class="sticky top-0 z-50 transition-all duration-300 rounded-lg p-3 text-sm max-w-7xl mx-auto mt-4 px-4 sm:px-6 lg:px-8 hidden"></div>


<!-- Main Content -->
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-2">Administrar Disponibilidad</h1>
    <p class="text-gray-600 mb-6">Crea nuevos slots o modifica/elimina existentes.</p>

    <!-- Layout: Three-column grid on large screens -->
    <div id="mainContainer" class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- Column 1: Date Selection (Manual or Recurrent) -->
        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">1. Seleccionar Fechas</h2>

            <!-- Selection Toggle -->
            <div class="mb-6 flex space-x-2 p-1 bg-gray-100 rounded-xl" role="tablist">
                <button id="manualSelectionToggle" data-mode="manual" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-colors bg-indigo-600 text-white" role="tab" aria-selected="true">
                    Manual
                </button>
                <button id="recurrenceSelectionToggle" data-mode="recurrence" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-colors text-gray-700 hover:bg-gray-200" role="tab" aria-selected="false">
                    Recurrente
                </button>
            </div>

            <!-- 1A: Manual Selection Container (Calendar) -->
            <div id="manualSelectionContainer" class="selection-container" style="display: block;">
                <div id="calendarContainer">
                    <!-- Calendar header and month navigation -->
                    <div class="flex justify-between items-center p-2 mb-4 bg-indigo-50 rounded-lg">
                        <button id="prevMonthBtn" class="p-2 rounded-full hover:bg-indigo-200 transition-colors" aria-label="Mes anterior">
                            <svg class="h-5 w-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <span id="currentMonthYear" class="text-lg font-bold text-gray-900">Cargando...</span>
                        <button id="nextMonthBtn" class="p-2 rounded-full hover:bg-indigo-200 transition-colors" aria-label="Mes siguiente">
                            <svg class="h-5 w-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>

                    <!-- Calendar Grid -->
                    <div class="grid grid-cols-7 text-center font-medium text-sm text-gray-500 mb-2">
                        <span>Lun</span><span>Mar</span><span>Mié</span><span>Jue</span><span>Vie</span><span>Sáb</span><span>Dom</span>
                    </div>
                    <div id="calendarGrid" class="grid grid-cols-7 gap-1">
                        <!-- Date cells are injected here -->
                    </div>
                </div>
            </div>

            <!-- 1B: Recurrence Selection Container -->
            <div id="recurrenceSelectionContainer" class="selection-container space-y-4" style="display: none;">
                <p class="text-sm text-gray-600">Selecciona los días de la semana y la duración para aplicar horarios en bloque.</p>

                <!-- Day Checkboxes (Friendly Selection) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Día(s) de la Semana</label>
                    <div id="recurrenceDayCheckboxes" class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-7 gap-2">
                        <!-- Note: value maps to Date.prototype.getDay() (0=Sun, 1=Mon, ..., 6=Sat) -->
                        <div>
                            <input type="checkbox" id="day-1" name="recurrenceDay" value="1"><label for="day-1" class="day-checkbox-label">Lun</label>
                        </div>
                        <div>
                            <input type="checkbox" id="day-2" name="recurrenceDay" value="2"><label for="day-2" class="day-checkbox-label">Mar</label>
                        </div>
                        <div>
                            <input type="checkbox" id="day-3" name="recurrenceDay" value="3"><label for="day-3" class="day-checkbox-label">Mié</label>
                        </div>
                        <div>
                            <input type="checkbox" id="day-4" name="recurrenceDay" value="4"><label for="day-4" class="day-checkbox-label">Jue</label>
                        </div>
                        <div>
                            <input type="checkbox" id="day-5" name="recurrenceDay" value="5"><label for="day-5" class="day-checkbox-label">Vie</label>
                        </div>
                        <div>
                            <input type="checkbox" id="day-6" name="recurrenceDay" value="6"><label for="day-6" class="day-checkbox-label">Sáb</label>
                        </div>
                        <div>
                            <input type="checkbox" id="day-0" name="recurrenceDay" value="0"><label for="day-0" class="day-checkbox-label">Dom</label>
                        </div>
                    </div>
                </div>

                <!-- Duration Input -->
                <div>
                    <label for="recurrenceDuration" class="block text-sm font-medium text-gray-700 mb-1">Próximos X días (Mínimo 7)</label>
                    <input type="number" id="recurrenceDuration" min="7" value="30" placeholder="e.g., 30" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                </div>

                <button id="previewRecurrenceBtn" class="w-full text-indigo-700 bg-indigo-100 py-2.5 px-4 rounded-lg hover:bg-indigo-200 transition-colors duration-200 font-medium">
                    Previsualizar y Seleccionar Fechas Recurrentes
                </button>
            </div>

            <!-- Shared Summary -->
            <div class="mt-6 p-3 bg-gray-50 rounded-lg border border-gray-200">
                <p class="text-sm font-medium text-gray-700">Fechas seleccionadas:</p>
                <div id="selectedDatesSummary" class="text-xs text-gray-500 mt-1 flex flex-wrap gap-2 min-h-6">
                    Ninguna
                </div>
                <!-- Clear selection button that only clears the current set -->
                <button id="clearSelectionBtn" class="mt-2 text-red-500 hover:text-red-700 text-xs font-medium disabled:opacity-50" disabled>Limpiar Selección</button>
            </div>
        </div>

        <!-- Column 2: Slot Configuration and Pending Slots (Create) -->
        <div class="space-y-8">
            <!-- Slot Definition Form -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">2. Asignar horario</h2>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="startTime" class="block text-sm font-medium text-gray-700">Hora de Inicio</label>
                        <input type="time" id="startTime" value="09:00" required class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                    </div>
                    <div>
                        <label for="endTime" class="block text-sm font-medium text-gray-700">Hora de Fin</label>
                        <input type="time" id="endTime" value="10:00" required class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                    </div>
                </div>

                <div class="mb-6">
                    <label for="price" class="block text-sm font-medium text-gray-700">Precio (opcional)</label>
                    <div class="mt-1 relative rounded-lg shadow-sm">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span class="text-gray-500 sm:text-sm">$</span>
                        </div>
                        <input type="number" id="price" placeholder="e.g., 50.00" min="0" step="0.01" class="block w-full pl-7 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                </div>

                <button id="applySlotsBtn" disabled class="w-full bg-indigo-600 text-white py-2.5 px-4 rounded-lg hover:bg-indigo-700 transition-colors duration-200 font-semibold disabled:opacity-50">
                    Aplicar Horario a <span id="datesAppliedCount">0</span> Fechas
                </button>
            </div>

            <!-- Pending Slots (To Be Saved) -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Turnos Pendientes</h3>
                    <span id="pendingSlotCountSummary" class="text-sm text-indigo-600 font-medium">0 turnos pendientes</span>
                </div>

                <ul id="pendingSlotsList" class="space-y-3 max-h-72 overflow-y-auto pr-2">
                    <li class="text-gray-400 text-center py-4">Aplica un horario para ver los nuevos slots aquí.</li>
                </ul>

                <button id="saveSlotsBtn" disabled class="w-full mt-6 bg-green-600 text-white py-2.5 px-4 rounded-lg hover:bg-green-700 transition-colors duration-200 font-semibold disabled:opacity-50">
                    Guardar
                </button>
            </div>
        </div>

        <!-- Existing Slots Section -->
        <div class="bg-white p-6 rounded-xl shadow-lg border border-indigo-100 existing-panel">
            <h2 class="text-xl font-semibold text-gray-900 mb-4 flex justify-between items-center">
                Turnos Existentes <span id="existingSlotsCount" class="text-sm font-medium text-gray-500">Cargando...</span>
            </h2>

            <button id="refreshExistingSlotsBtn"
                    class="mb-4 flex items-center text-indigo-600 hover:text-indigo-800 transition-colors disabled:opacity-50">

                <!-- Simple loading spinner -->
                <svg id="existingSlotsLoadingIcon"
                     class="w-5 h-5 mr-1 animate-spin hidden"
                     fill="none"
                     viewBox="0 0 24 24">
                    <circle class="opacity-25"
                            cx="12" cy="12" r="10"
                            stroke="currentColor"
                            stroke-width="4"></circle>
                    <path class="opacity-75"
                          fill="currentColor"
                          d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                </svg>

                <!-- Simple refresh arrow -->
                <svg id="refreshIcon"
                     class="w-5 h-5 mr-1"
                     fill="none"
                     stroke="currentColor"
                     stroke-width="2"
                     viewBox="0 0 24 24"
                     xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M4 4v6h6M20 20v-6h-6M5 19a9 9 0 0014-7V11M19 5a9 9 0 00-14 7v1" />
                </svg>

                Actualizar Vista
            </button>


            <div id="existingSlotsGrid" class="space-y-2">
                <!-- Existing slots will be rendered here -->
            </div>

            <!-- Pagination Controls -->
            <div id="paginationControls" class="mt-4 flex justify-between items-center border-t pt-4">
                <button id="prevPageBtn" class="px-3 py-1 text-sm font-medium rounded-md text-gray-700 bg-gray-100 hover:bg-gray-200 disabled:opacity-50">
                    &larr; Anterior
                </button>
                <span class="text-sm text-gray-600">Página <span id="currentPageDisplay">1</span> de <span id="totalPagesDisplay">1</span></span>
                <button id="nextPageBtn" class="px-3 py-1 text-sm font-medium rounded-md text-gray-700 bg-gray-100 hover:bg-gray-200 disabled:opacity-50">
                    Siguiente &rarr;
                </button>
            </div>

            <div id="existingSlotsLoading" class="hidden text-center py-8">
                <div class="animate-spin h-8 w-8 text-indigo-600 mx-auto">
                    <svg class="w-full h-full" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </div>
                <p class="mt-2 text-gray-500">Cargando slots...</p>
            </div>
        </div>

    </div>


</div>
</div>
<script src="./js/timeSlots.js"></script>
<script src="../commons/config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>
</html>